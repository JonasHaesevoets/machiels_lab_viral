---
title: "Differential Expression Analysis"
format: 
  html:
    code-fold: true
editor: visual
toc: true
execute:
  warning: false
  message: false
---

# 1) load in data and libraries + initialize custom functions

```{r, echo=FALSE}
easypackages::libraries("Seurat","tidyverse","SingleR", "ggridges", "viridis", "ggh4x", "celldex", "scCustomize", "SeuratWrappers", "ggExtra", "textTinyR", "patchwork", "pheatmap", "ggrepel", "tidyseurat", "ggpubr", "viridis", "writexl", "readxl", "presto", "scCustomize", "qs", "sctransform","glmGamPoi", "clusterProfiler", "enrichplot", "ExperimentHub", "scuttle", 'scmap',"cowplot","msigdbr", "fgsea",
                        'clusterProfiler',
                        'org.Mm.eg.db',
                        'tidyseurat',
                        'enrichplot',
                        'xlsx',
                        'Seurat.utils', "enrichR")
obj.v5 = read_rds("../../Documents/machiels_lab_viral/intermediate_data/seurat_obj_central_reclustered.rds")
DefaultAssay(obj.v5) <- "RNA"
obj.v5@assays$RNA



```

```{r}
counts <- GetAssayData(seurat_d60, assay = "RNA", layer = "counts")
counts <- counts[-(which(rownames(counts) %in% c("Xist", "Uty","Eif2s3y","Kdm5d","Ddx3y"))),]
seurat_d60@assays$RNA$counts <- counts
```

```{r}
counts <- GetAssayData(seurat_d60, assay = "RNA", layer = "data")
counts <- counts[-(which(rownames(counts) %in% c("Xist", "Uty","Eif2s3y","Kdm5d","Ddx3y"))),]
seurat_d60@assays$RNA$data <- counts
```

```{r}
process_markers <- function(data) {
  # Assign "NO" to diffexpressed column
  data$diffexpressed <- "NO"
  
  # Categorize genes as "UP" or "DOWN" based on avg_log2FC
  data$diffexpressed[data$avg_log2FC > 1] <- "UP"
  data$diffexpressed[data$avg_log2FC < -1] <- "DOWN"
  data$diffexpressed[data$p_val_adj == 0] = "P value of 0"


  
  
  # Add a column for labels
  data$delabel <- NA
  
  # Assign gene names as labels for differentially expressed genes
  data$delabel[data$diffexpressed != "NO"] <- data$gene[data$diffexpressed != "NO"]
  
  return(data)
}
```

```{r}


RNA <- seurat_d60@assays$RNA

# Define the gene(s) you want to remove
genes_to_remove <- c("Uty", "Xist")


# Filter out the specified genes from each matrix
RNA$data <- RNA$data[!rownames(RNA$data) %in% genes_to_remove, ]
RNA$counts <- RNA$counts[!rownames(RNA$counts) %in% genes_to_remove, ]

# Assign the modified RNA assay back to the Seurat object
seurat_d60@assays$RNA <- RNA
```

```{r}
process_markers2 <- function(data) {
  # Assign "NO" to diffexpressed column
  data$diffexpressed <- "NO"
  
  # Categorize genes as "UP" or "DOWN" based on avg_log2FC
  data$diffexpressed[data$avg_log2FC > 0.5] <- "UP"
  data$diffexpressed[data$avg_log2FC < -0.5] <- "DOWN"
  data$diffexpressed[data$p_val_adj == 0] = "P value of 0"


  
  
  # Add a column for labels
  data$delabel <- NA
  
  # Assign gene names as labels for differentially expressed genes
  data$delabel[data$diffexpressed != "NO"] <- data$gene[data$diffexpressed != "NO"]
  
  return(data)
}
```

```{r}
prepare_rnk <- function(data) {
  #remove NA
  data <- na.omit(data)

  # Arrange the dataframe by avg_log2FC in descending order
  ordered_data <- data %>% arrange(desc(avg_log2FC))
  
  # Select only the "gene" and "avg_log2FC" columns
  selected_data <- ordered_data[, c("gene", "avg_log2FC")]}

prepare_ora <- function(data) {
  #remove NA
  data <- na.omit(data)

  
  # Select only the "gene" and "avg_log2FC" columns
  selected_data <- data[, c("gene")]}

prepare_rnk_neg <- function(data) {
  #remove NA
  data <- na.omit(data)
  # Arrange the dataframe by avg_log2FC in descending order
  ordered_data <- data %>% arrange(avg_log2FC)
  
  # Select only the "gene" and "avg_log2FC" columns
  selected_data <- ordered_data[, c("gene", "avg_log2FC")]}
```

```{r}
remove_numbers_and_quotes_between_genes_with_tabs <- function(file_path) {
  # Read the file
  text <- readLines(file_path)
  
  # Pattern to match numbers between ""
  pattern_numbers <- "\"[0-9]+\""
  
  # Pattern to match "" between genes
  pattern_quotes_between_genes <- "(?<=\\w)\"\"(?=\\w)"
  
  # Replace numbers between ""
  text <- gsub(pattern_numbers, "", text)
  
  # Remove "" between genes
  text <- gsub(pattern_quotes_between_genes, "", text, perl = TRUE)
  
  # Add a tab between genes and values, and a tab after the values
  text <- gsub("(\\w+)\\s+(\\w+)", "\\1\t\\2\t", text)
  
  # Write modified text back to the file
  writeLines(text, file_path)
}

remove_quotes <- function(file_path) {
  # Read the file
  text <- readLines(file_path)
  
  
  # Remove the first row
  text <- text[-1]
  
  # Remove all occurrences of "
  text <- gsub("\"", "", text)
  
  # Remove spaces and replace with tabs
  text <- gsub(" ", "\t", text)
  
  text <- gsub("^\\s+", "", text)  # Remove initial whitespace

  
  # Write modified text back to the file
  writeLines(text, file_path)
}

```

# 2) Differential expression analysis comparing Ms4a3 + and -

```{r}

Idents(seurat_d60) = "sampletag_Ms4a3"
markers_pos<- FindMarkers(seurat_d60 ,
                                 ident.1 =  "Ms4a3_pos",
                                 ident.2 =  "Ms4a3_neg",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
markers_neg <- FindMarkers(seurat_d60 ,
                                 ident.1 =  "Ms4a3_neg",
                                 ident.2 =  "Ms4a3_pos",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
```

```{r}
markers_posfiltered = markers_pos[markers_pos$avg_log2FC > 1,]
nonsignficant_p_adj_ms4a3pos <- which(markers_posfiltered$p_val_adj <= 0.05)
markers_posfiltered <- markers_posfiltered[nonsignficant_p_adj_ms4a3pos, ]

write_xlsx(markers_pos,"../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_pos.xlsx")
write_xlsx(markers_posfiltered,"../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_posfiltered.xlsx")

markers_negfiltered = markers_neg[markers_neg$avg_log2FC > 1,]
nonsignficant_p_adj_Ms4a3neg <- which(markers_negfiltered$p_val_adj <= 0.05)
markers_negfiltered <- markers_negfiltered[nonsignficant_p_adj_Ms4a3neg, ]

write_xlsx(markers_neg,"../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_neg.xlsx")
write_xlsx(markers_negfiltered,"../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_neg_filtered.xlsx")
```

## 2A) volcano plot noMock Ms4a3 positive infected

```{r}
# Assign "NO" to diffexpressed column
markers_pos$diffexpressed <- "NO"

# Categorize genes as "UP" or "DOWN" based on avg_log2FC
markers_pos$diffexpressed[markers_pos$avg_log2FC > 1] <- "UP"
markers_pos$diffexpressed[markers_pos$avg_log2FC < -1] <- "DOWN"

# Add a column for labels
markers_pos$delabel <- NA

# Assign gene names as labels for differentially expressed genes
markers_pos$delabel[markers_pos$diffexpressed != "NO"] <-
  markers_pos$gene[markers_pos$diffexpressed != "NO"]  # Ensure consistent variable names




volcano_Ms4a3pos_noMock_sc <- ggplot(data = markers_pos,
       aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(markers_pos$avg_log2FC)),
                                 ceiling(max(markers_pos$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)

volcano_Ms4a3pos_noMock_sc

# Save the plot
ggsave("volcano_Ms4a3pos.png",
       width = 45, height = 20, units = "cm",
       path = "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/")
ggsave("volcano_Ms4a3pos.svg",
       width = 45, height = 20, units = "cm",
       path = "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/")
```

## 2B) volcano plot noMock Ms4a3 negative infected

```{r}
markers_neg$diffexpressed <- "NO"
markers_neg$diffexpressed[markers_neg$avg_log2FC > 1] <- "UP"

markers_neg$diffexpressed[markers_neg$avg_log2FC < -1] <- "DOWN"

markers_neg$delabel <- NA

markers_neg$delabel[markers_neg$diffexpressed != "NO"]<-markers_neg$gene[markers_neg$diffexpressed != "NO"]



volcano_Ms4a3neg_noMock_sc <- ggplot(data=markers_neg,
                           aes(x=avg_log2FC, y=-log10(p_val_adj), col = diffexpressed,                            label = delabel)) +
                           geom_point() + theme_minimal() +
                           scale_x_continuous(breaks = seq(floor(min (markers_neg$avg_log2FC)), 
                           ceiling(max(markers_neg$avg_log2FC)), by = 0.5)) +
                           geom_text_repel(max.overlaps = 100)
volcano_Ms4a3neg_noMock_sc
ggsave("volcano_Ms4a3neg.png",width = 45, height = 20, units = "cm", path = "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = "white")
ggsave("volcano_Ms4a3neg.svg",width = 45, height = 20, units = "cm", path = "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = "white")
```

```{r}
Idents(seurat_d60) = "condition"
markers_MuHV4vsMock<- FindMarkers(seurat_d60 ,
                                 ident.1 =  "MuHV4",
                                 ident.2 =  "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> 
                                 as_tibble(rownames="gene")
markers_MAV1vsMock <- FindMarkers(seurat_d60,
                                 ident.1 =  "MAV1",
                                 ident.2 =  "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
markers_PR8vsMock <- FindMarkers(seurat_d60,
                                 ident.1 =  "PR8",
                                 ident.2 =  "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
markers_PVMvsMock <- FindMarkers(seurat_d60,
                                 ident.1 =  "PVM",
                                 ident.2 =  "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
```

```{r}
markers_MuHV4vsMock_filtered = markers_MuHV4vsMock[abs(markers_MuHV4vsMock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_MuHV4vsMock_filtered$p_val_adj <= 0.05)
markers_MuHV4vsMock_filtered <- markers_MuHV4vsMock_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_MuHV4vsMock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MuHV4vsMock.xlsx")
write_xlsx(markers_MuHV4vsMock_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MuHV4vsMock_filtered.xlsx")
```

```{r}
positive_MuHv4vsMock = markers_MuHV4vsMock_filtered[markers_MuHV4vsMock_filtered$avg_log2FC >= 0.5,]
negative_MuHv4vsMock = markers_MuHV4vsMock_filtered[markers_MuHV4vsMock_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_MAV1vsMock_filtered = markers_MAV1vsMock[abs(markers_MAV1vsMock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_MAV1vsMock_filtered$p_val_adj <= 0.05)
markers_MAV1vsMock_filtered <- markers_MAV1vsMock_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_MAV1vsMock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MAV1vsMock.xlsx")
write_xlsx(markers_MAV1vsMock_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MAV1vsMock_filtered.xlsx")
```

```{r}
positive_MAV1vsMock = markers_MAV1vsMock_filtered[markers_MAV1vsMock_filtered$avg_log2FC >= 0.5,]
negative_MAV1vsMock = markers_MAV1vsMock_filtered[markers_MAV1vsMock_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_PR8vsMock_filtered = markers_PR8vsMock[abs(markers_PR8vsMock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_PR8vsMock_filtered$p_val_adj <= 0.05)
markers_PR8vsMock_filtered <- markers_PR8vsMock_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_PR8vsMock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PR8vsMock.xlsx")
write_xlsx(markers_PR8vsMock_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PR8vsMock_filtered.xlsx")
```

```{r}
positive_PR8vsMock = markers_PR8vsMock_filtered[markers_PR8vsMock_filtered$avg_log2FC >= 0.5,]
negative_PR8vsMock = markers_PR8vsMock_filtered[markers_PR8vsMock_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_PVMvsMock_filtered = markers_PVMvsMock[abs(markers_PVMvsMock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_PVMvsMock_filtered$p_val_adj <= 0.05)
markers_PVMvsMock_filtered <- markers_PVMvsMock_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_PVMvsMock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PVMvsMock.xlsx")
write_xlsx(markers_PVMvsMock_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PVMvsMock_filtered.xlsx")
```

```{r}
positive_PVMvsMock = markers_PVMvsMock_filtered[markers_PVMvsMock_filtered$avg_log2FC >= 0.5,]
negative_PVMvsMock = markers_PVMvsMock_filtered[markers_PVMvsMock_filtered$avg_log2FC <= -0.5,]
```

# 3) Differential expression analysis Mock vs Virus

```{r}
Idents(seurat_d60) = "condition"
markers_MuHV4vsMock<- FindMarkers(seurat_d60 ,
                                 ident.1 =  "MuHV4",
                                 ident.2 =  "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> 
                                 as_tibble(rownames="gene")
markers_MAV1vsMock <- FindMarkers(seurat_d60,
                                 ident.1 =  "MAV1",
                                 ident.2 =  "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
markers_PR8vsMock <- FindMarkers(seurat_d60,
                                 ident.1 =  "PR8",
                                 ident.2 =  "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
markers_PVMvsMock <- FindMarkers(seurat_d60,
                                 ident.1 =  "PVM",
                                 ident.2 =  "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
```

```{r}
markers_MuHV4vsMock_filtered = markers_MuHV4vsMock[abs(markers_MuHV4vsMock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_MuHV4vsMock_filtered$p_val_adj <= 0.05)
markers_MuHV4vsMock_filtered <- markers_MuHV4vsMock_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_MuHV4vsMock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MuHV4vsMock.xlsx")
write_xlsx(markers_MuHV4vsMock_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MuHV4vsMock_filtered.xlsx")
```

```{r}
positive_MuHv4vsMock = markers_MuHV4vsMock_filtered[markers_MuHV4vsMock_filtered$avg_log2FC >= 0.5,]
negative_MuHv4vsMock = markers_MuHV4vsMock_filtered[markers_MuHV4vsMock_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_MAV1vsMock_filtered = markers_MAV1vsMock[abs(markers_MAV1vsMock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_MAV1vsMock_filtered$p_val_adj <= 0.05)
markers_MAV1vsMock_filtered <- markers_MAV1vsMock_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_MAV1vsMock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MAV1vsMock.xlsx")
write_xlsx(markers_MAV1vsMock_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MAV1vsMock_filtered.xlsx")
```

```{r}
positive_MAV1vsMock = markers_MAV1vsMock_filtered[markers_MAV1vsMock_filtered$avg_log2FC >= 0.5,]
negative_MAV1vsMock = markers_MAV1vsMock_filtered[markers_MAV1vsMock_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_PR8vsMock_filtered = markers_PR8vsMock[abs(markers_PR8vsMock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_PR8vsMock_filtered$p_val_adj <= 0.05)
markers_PR8vsMock_filtered <- markers_PR8vsMock_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_PR8vsMock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PR8vsMock.xlsx")
write_xlsx(markers_PR8vsMock_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PR8vsMock_filtered.xlsx")
```

```{r}
positive_PR8vsMock = markers_PR8vsMock_filtered[markers_PR8vsMock_filtered$avg_log2FC >= 0.5,]
negative_PR8vsMock = markers_PR8vsMock_filtered[markers_PR8vsMock_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_PVMvsMock_filtered = markers_PVMvsMock[abs(markers_PVMvsMock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_PVMvsMock_filtered$p_val_adj <= 0.05)
markers_PVMvsMock_filtered <- markers_PVMvsMock_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_PVMvsMock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PVMvsMock.xlsx")
write_xlsx(markers_PVMvsMock_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PVMvsMock_filtered.xlsx")
```

```{r}
positive_PVMvsMock = markers_PVMvsMock_filtered[markers_PVMvsMock_filtered$avg_log2FC >= 0.5,]
negative_PVMvsMock = markers_PVMvsMock_filtered[markers_PVMvsMock_filtered$avg_log2FC <= -0.5,]
```

## 3A) volcano plot MAV1vs mock

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_MAV1vsMock = process_markers(markers_MAV1vsMock)
volcano_MAV1vsMock <- ggplot(data = volcano_MAV1vsMock,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_MAV1vsMock$avg_log2FC)),
                                  ceiling(max(volcano_MAV1vsMock$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100) 
volcano_MAV1vsMock
ggsave("volcano_MAV1vsMock.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_MAV1vsMock.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

## 3B) volcano plot MuHV4 vs mock

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_MuHV4vsMock = process_markers(markers_MuHV4vsMock)
volcano_MuHV4vsMock <- ggplot(data = volcano_MuHV4vsMock,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_MuHV4vsMock$avg_log2FC)),
                                  ceiling(max(volcano_MuHV4vsMock$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)
volcano_MuHV4vsMock
ggsave("volcano_MuHV4vsMock.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_MuHV4vsMock.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)

```

## 3C) volcano plot PR8 vs Mock

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_PR8vsMock = process_markers(markers_PR8vsMock)
volcano_PR8vsMock <- ggplot(data = volcano_PR8vsMock,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_PR8vsMock$avg_log2FC)),
                                  ceiling(max(volcano_PR8vsMock$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)
volcano_PR8vsMock
ggsave("volcano_PR8vsMock.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_PR8vsMock.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

## 3D) volcano plot PVM vs Mock

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_PVMvsMock = process_markers(markers_PVMvsMock)
volcano_PVMvsMock <- ggplot(data = volcano_PVMvsMock,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_PVMvsMock$avg_log2FC)),
                                  ceiling(max(volcano_PVMvsMock$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 1000)
volcano_PVMvsMock
ggsave("volcano_PVMvsMock.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_PVMvsMock.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

# 4) Differential expression analysis

```{r}
Idents(seurat_d60) = "sampletag_name"
markers_MuHV4_Ms4a3<- FindMarkers(seurat_d60,
                                 ident.1 =  "MuHV4_Ms4a3_pos",
                                 ident.2 =  "MuHV4_Ms4a3_neg",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")

markers_PR8_Ms4a3 <- FindMarkers(seurat_d60,
                                 ident.1 =  "PR8_Ms4a3_pos",
                                 ident.2 =  "PR8_Ms4a3_neg",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")

markers_PVM_Ms4a3 <- FindMarkers(seurat_d60,
                                 ident.1 =  "PVM_Ms4a3_pos",
                                  ident.2 =  "PVM_Ms4a3_neg",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")

markers_MAV1_Ms4a3 <- FindMarkers(seurat_d60,
                                 ident.1 =  "MAV1_Ms4a3_pos",
                                 ident.2 =  "MAV1_Ms4a3_neg",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")

markers_Mock_Ms4a3 <- FindMarkers(seurat_d60,
                                 ident.1 =  "Mock_Ms4a3_pos",
                                 ident.2 =  "Mock_Ms4a3_neg",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")

```

```{r}
markers_MuHV4_Ms4a3_filtered = markers_MuHV4_Ms4a3[abs(markers_MuHV4_Ms4a3$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_MuHV4_Ms4a3_filtered$p_val_adj <= 0.05)
markers_MuHV4_Ms4a3_filtered <- markers_MuHV4_Ms4a3_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_MuHV4_Ms4a3, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MuHV4_Ms4a3.xlsx")
write_xlsx(markers_MuHV4_Ms4a3_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MuHV4_Ms4a3_filtered.xlsx")
```

```{r}
positive_Ms4a3_MuHV4 = markers_MuHV4_Ms4a3_filtered[markers_MuHV4_Ms4a3_filtered$avg_log2FC >= 0.5,]
negative_Ms4a3_MuHV4 = markers_MuHV4_Ms4a3_filtered[markers_MuHV4_Ms4a3_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_MAV1_Ms4a3_filtered = markers_MAV1_Ms4a3[abs(markers_MAV1_Ms4a3$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_MAV1_Ms4a3_filtered$p_val_adj <= 0.05)
markers_MAV1_Ms4a3_filtered <- markers_MAV1_Ms4a3_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_MAV1_Ms4a3, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MAV1_Ms4a3.xlsx")
write_xlsx(markers_MAV1_Ms4a3_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_MAV1_Ms4a3_filtered.xlsx")
```

```{r}
positive_Ms4a3_MAV1 = markers_MAV1_Ms4a3_filtered[markers_MAV1_Ms4a3_filtered$avg_log2FC >= 0.5,]
negative_Ms4a3_MAV1 = markers_MAV1_Ms4a3_filtered[markers_MAV1_Ms4a3_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_Mock_Ms4a3_filtered = markers_Mock_Ms4a3[abs(markers_Mock_Ms4a3$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_Mock_Ms4a3_filtered$p_val_adj <= 0.05)
markers_Mock_Ms4a3_filtered <- markers_Mock_Ms4a3_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_Mock_Ms4a3, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_Mock_Ms4a3.xlsx")
write_xlsx(markers_Mock_Ms4a3_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_Mock_Ms4a3_filtered.xlsx")
```

```{r}
positive_Ms4a3_mock = markers_Mock_Ms4a3_filtered[markers_Mock_Ms4a3_filtered$avg_log2FC >= 0.5,]
negative_Ms4a3_mock = markers_Mock_Ms4a3_filtered[markers_Mock_Ms4a3_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_PR8_Ms4a3_filtered = markers_PR8_Ms4a3[abs(markers_PR8_Ms4a3$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_PR8_Ms4a3_filtered$p_val_adj <= 0.05)
markers_PR8_Ms4a3_filtered <- markers_PR8_Ms4a3_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_PR8_Ms4a3, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PR8_Ms4a3.xlsx")
write_xlsx(markers_PR8_Ms4a3_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PR8_Ms4a3_filtered.xlsx")
```

```{r}
positive_Ms4a3_PR8 = markers_PR8_Ms4a3_filtered[markers_PR8_Ms4a3_filtered$avg_log2FC >= 0.5,]
negative_Ms4a3_PR8 = markers_PR8_Ms4a3_filtered[markers_PR8_Ms4a3_filtered$avg_log2FC <= -0.5,]
```

```{r}
markers_PVM_Ms4a3_filtered = markers_PVM_Ms4a3[abs(markers_PVM_Ms4a3$avg_log2FC) > 0.5,]
nonsignficant_p_adj_Mock <- which(markers_PVM_Ms4a3_filtered$p_val_adj <= 0.05)
markers_PVM_Ms4a3_filtered <- markers_PVM_Ms4a3_filtered[nonsignficant_p_adj_Mock, ]

write_xlsx(markers_PVM_Ms4a3, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PVM_Ms4a3.xlsx")
write_xlsx(markers_PVM_Ms4a3_filtered, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_PVM_Ms4a3_filtered.xlsx")
```

```{r}
positive_Ms4a3_PVM = markers_PVM_Ms4a3_filtered[markers_PVM_Ms4a3_filtered$avg_log2FC >= 0.5,]
negative_Ms4a3_PVM = markers_PVM_Ms4a3_filtered[markers_PVM_Ms4a3_filtered$avg_log2FC <= -0.5,]
```

## 4A) volcano plot MAV1 Ms4a3

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_MAV1_Ms4a3 = process_markers(markers_MAV1_Ms4a3)
volcano_MAV1_Ms4a3 <- ggplot(data = volcano_MAV1_Ms4a3,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_MAV1_Ms4a3$avg_log2FC)),
                                  ceiling(max(volcano_MAV1_Ms4a3$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100) 
volcano_MAV1_Ms4a3
ggsave("volcano_MAV1_Ms4a3.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_MAV1_Ms4a3.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

## 4B) volcano plot MuHV4 Ms4a3

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_MuHV4_Ms4a3 = process_markers(markers_MuHV4_Ms4a3)
volcano_MuHV4_Ms4a3 <- ggplot(data = volcano_MuHV4_Ms4a3,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_MuHV4_Ms4a3$avg_log2FC)),
                                  ceiling(max(volcano_MuHV4_Ms4a3$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)
volcano_MuHV4_Ms4a3
ggsave("volcano_MuHV4_Ms4a3.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_MuHV4_Ms4a3.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

## 4C) volcano plot PR8 Ms4a3

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_PR8_Ms4a3 = process_markers(markers_PR8_Ms4a3)
volcano_PR8_Ms4a3 <- ggplot(data = volcano_PR8_Ms4a3,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_PR8_Ms4a3$avg_log2FC)),
                                  ceiling(max(volcano_PR8_Ms4a3$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)
volcano_PR8_Ms4a3
ggsave("volcano_PR8_Ms4a3.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_PR8_Ms4a3.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

## 4D) volcano plot PVM Ms4a3

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_PVM_Ms4a3 = process_markers(markers_PVM_Ms4a3)
volcano_PVM_Ms4a3 <- ggplot(data = volcano_PVM_Ms4a3,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_PVM_Ms4a3$avg_log2FC)),
                                  ceiling(max(volcano_PVM_Ms4a3$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)
volcano_PVM_Ms4a3
ggsave("volcano_PVM_Ms4a3.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_PVM_Ms4a3.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

## 4E) volcano plot Mock Ms4a3

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_Mock_Ms4a3 = process_markers(markers_Mock_Ms4a3)
volcano_Mock_Ms4a3 <- ggplot(data = volcano_Mock_Ms4a3,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_Mock_Ms4a3$avg_log2FC)),
                                  ceiling(max(volcano_Mock_Ms4a3$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)
volcano_Mock_Ms4a3
ggsave("volcano_Mock_Ms4a3.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_Mock_Ms4a3.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

# 5) Differential expression analysis virus types

```{r}
muhv4_rows <- which(seurat_d60@meta.data$virus %in% "MuHV4")
mav1_rows <- which(seurat_d60@meta.data$virus %in% "MAV1")
pr8_rows <- which(seurat_d60@meta.data$virus %in% "PR8")
pvm_rows <- which(seurat_d60@meta.data$virus %in% "PVM")
mock_rows <- which(seurat_d60@meta.data$virus == "Mock")  # Identify Mock rows

# Create logical vectors
is_dna_virus <- logical(length(seurat_d60@meta.data$virus))
is_rna_virus <- logical(length(seurat_d60@meta.data$virus))
is_mock <- logical(length(seurat_d60@meta.data$virus))  # New vector for Mock

# Assign TRUE to corresponding elements in logical vectors
is_dna_virus[muhv4_rows] <- TRUE
is_dna_virus[mav1_rows] <- TRUE

is_rna_virus[pr8_rows] <- TRUE
is_rna_virus[pvm_rows] <- TRUE

is_mock[mock_rows] <- TRUE  # Assign TRUE to Mock rows

# Combine classifications (modify if needed for more categories)
virus_classification <- ifelse(is_dna_virus, "DNA_virus",
                               ifelse(is_rna_virus, "RNA_virus", "Mock"))

# Add the new metadata column
seurat_d60 <- AddMetaData(seurat_d60, metadata = virus_classification, col.name = "virus_classification")
```

```{r}
Idents(seurat_d60) = "virus_classification"
markers_DNA_vs_mock<- FindMarkers(seurat_d60,
                                 ident.1 =  "DNA_virus",
                                 ident.2 = "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")

markers_RNA_vs_mock<- FindMarkers(seurat_d60,
                                 ident.1 =  "RNA_virus",
                                 ident.2 = "Mock",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")

markers_DNA_vs_RNA<- FindMarkers(seurat_d60,
                                 ident.1 =  "DNA_virus",
                                 ident.2 = "RNA_virus",
                                 test.use = "wilcox", 
                                 assay = "RNA",
                                 min.pct = 0.2) |> as_tibble(rownames="gene")
```

```{r}
markers_DNA_vs_mock_filter = markers_DNA_vs_mock[abs(markers_DNA_vs_mock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_DNA <- which(markers_DNA_vs_mock$p_val_adj <= 0.05)
markers_DNA_vs_mock_filter <- markers_DNA_vs_mock_filter[nonsignficant_p_adj_DNA, ]

write_xlsx(markers_DNA_vs_mock_filter, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_DNA_vs_mock_filter.xlsx")
write_xlsx(markers_DNA_vs_mock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_DNA_vs_mock.xlsx")
```

```{r}
positive_DNAMock = markers_DNA_vs_mock_filter[markers_DNA_vs_mock_filter$avg_log2FC >= 0.5,]
negative_DNAMock = markers_DNA_vs_mock_filter[markers_DNA_vs_mock_filter$avg_log2FC <= -0.5,]
```

```{r}

markers_RNA_vs_mock_filter = markers_RNA_vs_mock[abs(markers_RNA_vs_mock$avg_log2FC) > 0.5,]
nonsignficant_p_adj_RNA <- which(markers_RNA_vs_mock$p_val_adj <= 0.05)
markers_RNA_vs_mock_filter <- markers_RNA_vs_mock_filter[nonsignficant_p_adj_RNA, ]

write_xlsx(markers_RNA_vs_mock_filter, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_RNA_vs_mock_filter.xlsx")
write_xlsx(markers_RNA_vs_mock, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_RNA_vs_mock.xlsx")
```

```{r}
positive_RNAMock = markers_RNA_vs_mock_filter[markers_RNA_vs_mock_filter$avg_log2FC >= 0.5,]
negative_RNAMock = markers_RNA_vs_mock_filter[markers_RNA_vs_mock_filter$avg_log2FC <= -0.5,]
```

```{r}
markers_DNA_vs_RNA_filter = markers_DNA_vs_RNA[abs(markers_DNA_vs_RNA$avg_log2FC) > 0.5,]
nonsignficant_p_adj_DNARNA <- which(markers_DNA_vs_RNA$p_val_adj <= 0.05)
markers_DNA_vs_RNA_filter <- markers_DNA_vs_RNA_filter[nonsignficant_p_adj_DNARNA, ]

write_xlsx(markers_DNA_vs_RNA_filter, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_DNA_vs_RNA_filter.xlsx")
write_xlsx(markers_DNA_vs_RNA, "../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_tables/markers_DNA_vs_RNA.xlsx")
```

```{r}
positive_DNARNA = markers_DNA_vs_RNA_filter[markers_DNA_vs_RNA_filter$avg_log2FC >= 0.5,]
negative_DNARNA = markers_DNA_vs_RNA_filter[markers_DNA_vs_RNA_filter$avg_log2FC <= -0.5,]
```

## 5A) volcano plot DNA vs Mock

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_DNAvsmock = process_markers2(markers_DNA_vs_mock)
volcano_DNAvsmock <- ggplot(data = volcano_DNAvsmock,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_DNAvsmock$avg_log2FC)),
                                  ceiling(max(volcano_DNAvsmock$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)
volcano_DNAvsmock
ggsave("volcano_DNAvsMock.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_DNAvsMock.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

## 5B) volcano plot DNA vs RNA

```{r}
#| fig-width: 18
#| fig-height: 9
volcano_DNAvsRNA = process_markers2(markers_DNA_vs_RNA)
volcano_DNAvsRNA <- ggplot(data = volcano_DNAvsRNA,
                                                aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) +
  geom_point() +
  theme_minimal() +
  scale_x_continuous(breaks = seq(floor(min(volcano_DNAvsRNA$avg_log2FC)),
                                  ceiling(max(volcano_DNAvsRNA$avg_log2FC)), by = 0.5)) +
  geom_text_repel(max.overlaps = 100)
volcano_DNAvsRNA
ggsave("volcano_DNAvsRNA.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
ggsave("volcano_DNAvsRNA.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```

## 5C) volcano plot RNA vs Mock

```{r}
#| fig-width: 18
#| fig-height: 9

volcano_RNAvsmock = process_markers2(markers_RNA_vs_mock)
volcano_RNAvsmock <- ggplot(data = volcano_RNAvsmock, aes(x = avg_log2FC, y = -log10(p_val_adj), col = diffexpressed, label = delabel)) + geom_point() + theme_minimal() + scale_x_continuous(breaks = seq(floor(min(volcano_RNAvsmock$avg_log2FC)),
                                  ceiling(max(volcano_RNAvsmock$avg_log2FC)), by = 0.5)) + geom_text_repel(max.overlaps = 100)

volcano_RNAvsmock

ggsave("volcano_RNAvsMock.png", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9) 
ggsave("volcano_RNAvsMock.svg", path ="../../Documents/machiels_lab_viral/CaseStudy_DEA/DEA_plots/", bg = 'white', width = 18, height = 9)
```
